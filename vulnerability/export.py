"""
    导出所有资源到文件中  用于导入到ocean_ctf 平台
"""
import os

import yaml


def find_files(directory, filename):
    results = []
    for root, dirs, files in os.walk(directory):
        for file in files:
            if file == filename:
                results.append(os.path.join(root, file))
    return results


def main():
    current_directory = os.getcwd()
    if os.path.exists("vulnerability.yaml"):
        # 备份文件
        os.rename("vulnerability.yaml", "_vulnerability.yaml")
    vuln_files = find_files(current_directory, "vulnerability.yaml")
    datas = []
    for vuln_file in vuln_files:
        with open(vuln_file, "r") as f:
            try:
                yaml_data = yaml.safe_load(f)
            except yaml.YAMLError as e:
                print("Error while parsing YAML file:", e)
                continue
        if yaml_data.get("build"):
            print("building {}".format(yaml_data['image']))
            work_dir = os.path.dirname(vuln_file)
            context = yaml_data.get("context", ".")
            dockerfile = yaml_data.get("dockerfile", "Dockerfile")
            os.system(f"cd {work_dir} docker build {context} -t {yaml_data['image']} -f {dockerfile}")
        datas.append(yaml_data)
    print("Export Vulnerability Count {}".format(len(datas)))
    with open("vulnerability.yaml", 'w') as file:
        try:
            yaml.dump(datas, file, default_flow_style=False)
        except yaml.YAMLError as e:
            print("Error while writing YAML file:", e)


if __name__ == "__main__":
    main()
